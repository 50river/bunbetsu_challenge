<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>金沢市ごみ分別チャレンジ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
	body {
	  font-family: sans-serif;
	  text-align: center;
	  margin: 20px;
	  padding: 0;
	}
	h1 {
	  font-size: 1.8em;
	}
	.question {
	  font-size: 1.4em;
	  margin: 20px 10px 10px;
	}
	.result {
	  font-size: 1.2em;
	  margin: 10px;
	  color: #444;
	  min-height: 1.5em;
	}
	.choices {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  gap: 10px;
	  max-width: 400px;
	  margin: 0 auto;
	}
	.choices button {
	  width: 100%;
	  max-width: 300px;
	  padding: 12px;
	  font-size: 1em;
	  border: none;
	  border-radius: 8px;
	  background-color: #f0f0f0;
	}
	.choices button:hover {
	  background-color: #ddd;
	}
	#timer {
	  font-size: 1.1em;
	  margin-top: 10px;
	}
	button.start, .back-btn, .share-btn {
	  font-size: 1.1em;
	  padding: 10px 20px;
	  border-radius: 8px;
	  margin: 10px;
	}
	.summary {
	  margin-top: 30px;
	  text-align: left;
	  max-width: 600px;
	  margin-left: auto;
	  margin-right: auto;
	  font-size: 0.95em;
	}
	.summary table {
	  width: 100%;
	  border-collapse: collapse;
	}
	.summary th, .summary td {
	  border: 1px solid #ccc;
	  padding: 8px;
	  text-align: center;
	}
	.summary th {
	  background-color: #f8f8f8;
	}
	.note {
	  font-size: 0.9em;
	  color: #666;
	  margin-top: 10px;
	}
  </style>
</head>
<body>
  <h1 id="title">金沢市ごみ分別チャレンジ</h1>
  <p id="intro">表示された品名を、正しいごみの種類に分類しよう！</p>
  <p class="note">※分別データは金沢市の <a href="https://catalog-data.city.kanazawa.ishikawa.jp/dataset/172014-gomibunbetsujiten" target="_blank">オープンデータ</a> を使用しています。</p>
  <button class="start" onclick="startGame()">ゲーム開始</button>

  <div id="game" style="display:none;">
	<div class="question" id="question"></div>
	<div class="result" id="result">&nbsp;</div>
	<div class="choices">
	  <button onclick="answer('燃やすごみ')">燃やすごみ</button>
	  <button onclick="answer('燃やさないごみ')">燃やさないごみ</button>
	  <button onclick="answer('資源ごみ')">資源ごみ</button>
	  <button onclick="answer('粗大ごみ')">粗大ごみ</button>
	  <button onclick="answer('その他')">その他</button>
	</div>
	<div id="timer"></div>
  </div>

  <script>
	let quizData = [];
	let currentIndex = 0;
	let score = 0;
	let timer;
	let timeLeft = 60;
	let answeredList = [];

	function startGame() {
	  document.querySelector('button.start').style.display = 'none';
	  document.getElementById('game').style.display = 'block';
	  document.getElementById('title').style.display = 'none';
	  document.getElementById('intro').style.display = 'none';
	  document.querySelector('.note').style.display = 'none';
	  currentIndex = 0;
	  score = 0;
	  timeLeft = 60;
	  answeredList = [];

	  fetchCSVData().then(data => {
		quizData = shuffle(data).slice(0, 100);
		showQuestion();
		timer = setInterval(() => {
		  timeLeft--;
		  document.getElementById('timer').innerText = `残り時間: ${timeLeft}秒`;
		  if (timeLeft <= 0) {
			clearInterval(timer);
			endGame();
		  }
		}, 1000);
	  });
	}

	function fetchCSVData() {
	  const url = 'https://catalog-data.city.kanazawa.ishikawa.jp/dataset/ca0f0586-51bc-419c-8a1f-8ce432bf3fd9/resource/4da14709-f5c6-44dc-afc8-f6e9a07656e1/download/bunbetsujiten_r7.4.csv';
	  return fetch(url)
		.then(res => res.arrayBuffer())
		.then(buffer => {
		  const decoder = new TextDecoder('shift-jis');
		  const text = decoder.decode(buffer);
		  const parsed = Papa.parse(text, { header: true }).data;
		  return parsed
			.filter(row => row['品　名'] && row['ごみの種類'])
			.map(row => ({
			  item: row['品　名'],
			  category: simplifyCategory(row['ごみの種類'])
			}));
		});
	}

	function simplifyCategory(category) {
	  if (!category) return 'その他';
	  if (category.includes('燃やす')) return '燃やすごみ';
	  if (category.includes('燃やさない')) return '燃やさないごみ';
	  if (category.includes('資源')) return '資源ごみ';
	  if (category.includes('粗大')) return '粗大ごみ';
	  return 'その他';
	}

	function showQuestion() {
	  if (currentIndex >= quizData.length) return endGame();
	  const q = quizData[currentIndex];
	  document.getElementById('question').innerText = `「${q.item}」はどのごみ？`;
	  document.getElementById('result').innerText = '\u00a0';
	}

	function answer(choice) {
	  const current = quizData[currentIndex];
	  const correct = current.category;
	  const isCorrect = (choice === correct);
	  if (isCorrect) {
		score++;
		document.getElementById('result').innerText = '正解！';
	  } else {
		document.getElementById('result').innerText = `不正解。正しくは「${correct}」です。`;
	  }
	  answeredList.push({ item: current.item, correct: correct, user: choice, result: isCorrect });
	  currentIndex++;
	  setTimeout(showQuestion, 500);
	}

	function endGame() {
	  const total = answeredList.length;
	  const accuracy = total ? Math.round((score / total) * 100) : 0;

	  let summaryHTML = `
		<h2>ゲーム終了！</h2>
		<p>解答数：${total} 問 ／ 正解数：${score} 問 ／ 正解率：${accuracy}%</p>
		<button class="back-btn" onclick="location.reload()">スタート画面に戻る</button>
		<button class="share-btn" onclick="shareResult(${score}, ${total}, ${accuracy})">結果をSNSでシェア</button>
		<div class="summary">
		<table>
		  <tr><th>#</th><th>品名</th><th>あなたの回答</th><th>正解</th><th>結果</th></tr>
	  `;

	  answeredList.forEach((entry, i) => {
		summaryHTML += `
		  <tr>
			<td>${i + 1}</td>
			<td>${entry.item}</td>
			<td>${entry.user}</td>
			<td>${entry.correct}</td>
			<td>${entry.result ? '〇' : '×'}</td>
		  </tr>
		`;
	  });

	  summaryHTML += '</table></div>';
	  document.getElementById('game').innerHTML = summaryHTML;
	}

	function shareResult(score, total, accuracy) {
	  const text = `金沢市ごみ分別チャレンジ\n正解数：${score}/${total}問（正解率：${accuracy}%）\nあなたもチャレンジしてみて！`;
	  const url = location.href;
	  const tweet = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
	  window.open(tweet, '_blank');
	}

	function shuffle(array) {
	  for (let i = array.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	  }
	  return array;
	}
  </script>
</body>
</html>